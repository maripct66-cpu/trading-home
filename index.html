<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trading Home â€“ Live</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <style>
    :root{
      --bg:#0b0f19; --panel:#121826; --text:#e5e7eb; --muted:#94a3b8;
      --bull:#22c55e; --bear:#ef4444; --accent:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         background:var(--bg); color:var(--text)}
    header{position:sticky; top:0; z-index:10; background:#0b0f19cc; backdrop-filter: blur(8px);
           border-bottom:1px solid #1f2937}
    .wrap{max-width:1080px; margin:0 auto; padding:16px}
    h1{margin:6px 0 12px; font-size:28px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .input{flex:1; min-width:220px; padding:12px 14px; border-radius:12px; border:1px solid #1f2937; background:var(--panel); color:var(--text)}
    .btn{padding:12px 16px; border:0; border-radius:12px; background:var(--accent); color:#001018; font-weight:600; cursor:pointer}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .sel{padding:12px 14px; border-radius:12px; border:1px solid #1f2937; background:var(--panel); color:var(--text)}
    .card{background:var(--panel); border:1px solid #1f2937; border-radius:16px; padding:16px}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){ .grid-2{grid-template-columns: 2fr 1fr} }
    .muted{color:var(--muted); font-size:12px}
    .kpi{display:flex; gap:10px; flex-wrap:wrap}
    .pill{background:#0f172a; border:1px solid #1f2937; border-radius:999px; padding:8px 12px; font-size:12px}
    #chart{width:100%; height:460px}
    a{color:#7dd3fc}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Trading Home â€“ Live</h1>
      <div class="row">
        <input id="symbol" class="input" placeholder="Simbolo Binance (es. BTCUSDT, ETHUSDT, SOLUSDT)"/>
        <select id="interval" class="sel">
          <option value="1m">1m</option>
          <option value="5m">5m</option>
          <option value="15m">15m</option>
          <option value="1h" selected>1h</option>
          <option value="4h">4h</option>
          <option value="1d">1d</option>
        </select>
        <button id="search" class="btn">ðŸ”Ž Cerca</button>
        <button id="refresh" class="btn">â†» Aggiorna</button>
      </div>
      <div class="muted" style="margin-top:6px">
        Dati live gratuiti da Binance (solo crypto). Per altri asset: carica un CSV qui sotto.
      </div>
    </div>
  </header>

  <main class="wrap grid grid-2" style="padding-top:16px">
    <section class="card" style="grid-column:1 / -1">
      <div id="chart"></div>
      <div class="row" style="justify-content:space-between; margin-top:8px">
        <div class="muted">Candele rosse/verde â€¢ EMA 20/50/200</div>
        <div class="muted" id="status">Pronto</div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">ProbabilitÃ  (didattica)</h3>
      <div class="kpi" style="margin-bottom:8px">
        <span class="pill">Investire: <b id="kpiBuy">â€”%</b></span>
        <span class="pill">Disinvestire: <b id="kpiSell">â€”%</b></span>
        <span class="pill">Candele: <b id="kpiCount">â€”</b></span>
      </div>
      <div class="muted">
        Calcolo semplice: performance recente + incroci EMA.<br/>
        Non costituisce consulenza dâ€™investimento.
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 8px">Carica CSV (azioni/bond/commodities)</h3>
      <input type="file" id="csv" accept=".csv" />
      <div class="muted" style="margin-top:8px">
        Formato: <code>timestamp,open,high,low,close,volume</code> (millisecondi o data ISO).<br/>
        Il grafico si aggiorna con i tuoi dati locali (niente invii a server).
      </div>
    </section>
  </main>

  <script>
    // -------- Utils --------
    const $ = (id)=>document.getElementById(id);
    const setText = (id, t)=>{ $(id).textContent = t; };

    function ema(values, period){
      const k = 2/(period+1); const out=[]; let prev;
      for(let i=0;i<values.length;i++){
        const v=values[i];
        if(i<period-1){ out.push(null); }
        else if(i===period-1){ const sma = avg(values.slice(0,period)); out.push(sma); prev=sma; }
        else{ const n=v*k + prev*(1-k); out.push(n); prev=n; }
      }
      return out;
    }
    const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;

    function toApexSeries(candles){
      return candles.map(c=>({ x: new Date(c.time*1000), y:[c.open,c.high,c.low,c.close] }));
    }

    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(',').map(h=>h.trim().toLowerCase());
      const idx = {
        t: header.findIndex(h=>["timestamp","date","time","t"].includes(h)),
        o: header.findIndex(h=>["open","o"].includes(h)),
        h: header.findIndex(h=>["high","h"].includes(h)),
        l: header.findIndex(h=>["low","l"].includes(h)),
        c: header.findIndex(h=>["close","c"].includes(h)),
        v: header.findIndex(h=>["volume","v"].includes(h)),
      };
      const rows=[];
      for(let i=1;i<lines.length;i++){
        const cols = lines[i].split(',');
        if(cols.length<5) continue;
        const tsRaw = cols[idx.t];
        const ts = /^\d{10,13}$/.test(tsRaw) ? Math.floor(Number(tsRaw)/1000) : Math.floor(new Date(tsRaw).getTime()/1000);
        rows.push({
          time: ts,
          open: Number(cols[idx.o]), high: Number(cols[idx.h]),
          low: Number(cols[idx.l]), close: Number(cols[idx.c]),
          volume: idx.v>=0 ? Number(cols[idx.v]) : undefined
        });
      }
      return rows.sort((a,b)=>a.time-b.time);
    }

    // -------- Chart setup --------
    let chart, chartOptions, lastCandles=[];
    function initChart(){
      chartOptions = {
        chart: {
          type: 'candlestick',
          height: 460,
          background: '#121826',
          foreColor: '#e5e7eb',
          animations: { enabled: true },
          toolbar: { show: true, tools: { pan:true, zoom:true, zoomin:true, zoomout:true, reset:true } },
          zoom: { enabled: true }
        },
        theme: { mode: 'dark' },
        series: [],
        xaxis: { type: 'datetime' },
        yaxis: { tooltip: { enabled: true }, decimalsInFloat: 2 },
        grid: { borderColor: '#1f2937' },
        plotOptions: {
          candlestick: {
            colors: { upward: getCSS('--bull'), downward: getCSS('--bear') },
            wick: { useFillColor: true }
          }
        },
        title: { text: 'Grafico', align: 'left', style: { color:'#e5e7eb' } }
      };
      chart = new ApexCharts(document.querySelector("#chart"), chartOptions);
      chart.render();
    }
    function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

    function updateChartWithCandles(candles){
      lastCandles = candles.slice();
      const closes = candles.map(c=>c.close);
      const ema20 = ema(closes,20);
      const ema50 = ema(closes,50);
      const ema200= ema(closes,200);

      const base = [
        { name:'Candele', type:'candlestick', data: toApexSeries(candles) },
        { name:'EMA20',   type:'line', data: candles.map((c,i)=>({x:new Date(c.time*1000), y: ema20[i] ?? null})), color:getCSS('--accent') },
        { name:'EMA50',   type:'line', data: candles.map((c,i)=>({x:new Date(c.time*1000), y: ema50[i] ?? null})), color:'#9aa7ff' },
        { name:'EMA200',  type:'line', data: candles.map((c,i)=>({x:new Date(c.time*1000), y: ema200[i] ?? null})), color:'#f59e0b' },
      ];
      chart.updateSeries(base, true);
      updateKPIs(candles, ema20, ema50);
    }

    function updateKPIs(candles, ema20, ema50){
      setText('kpiCount', candles.length);
      if(candles.length<5){ setText('kpiBuy','â€”%'); setText('kpiSell','â€”%'); return; }
      const first = candles[0].close, last = candles[candles.length-1].close;
      const perf = ((last-first)/first)*100;
      // bonus/malus su incrocio EMA20 vs EMA50 nellâ€™ultima candela
      const i = ema50.lastIndexOf(ema50.find(v=>v!=null));
      let bonus = 0;
      if(i>0 && ema20[i]!=null && ema50[i]!=null){
        const crossedUp = ema20[i] > ema50[i] && ema20[i-1] <= ema50[i-1];
        const crossedDn = ema20[i] < ema50[i] && ema20[i-1] >= ema50[i-1];
        if(crossedUp) bonus += 8;
        if(crossedDn) bonus -= 8;
      }
      const buy = Math.max(5, Math.min(95, 50 + perf*0.6 + bonus));
      setText('kpiBuy',  buy.toFixed(0)+'%');
      setText('kpiSell', (100-buy).toFixed(0)+'%');
    }

    // -------- Binance fetch (CORS ok) --------
    async function fetchBinance(symbol, interval='1h', limit=500){
      const url = `https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${limit}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error('Errore Binance');
      const data = await r.json();
      return data.map(d=>({
        time: Math.floor(d[0]/1000),
        open: Number(d[1]), high: Number(d[2]),
        low: Number(d[3]),  close: Number(d[4]),
        volume: Number(d[5])
      }));
    }

    // -------- CSV handler --------
    $('csv').addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      $('status').textContent = 'Carico CSVâ€¦';
      try{
        const text = await file.text();
        const rows = parseCSV(text);
        if(rows.length<20) throw new Error('CSV troppo corto o colonne non riconosciute');
        updateChartWithCandles(rows);
        $('status').textContent = `CSV caricato: ${rows.length} candele`;
      }catch(err){
        $('status').textContent = 'Errore CSV: ' + err.message;
        alert(err.message);
      }
    });

    // -------- UI actions --------
    $('search').addEventListener('click', async ()=>{
      const sym = $('symbol').value.trim().toUpperCase();
      if(!sym){ alert('Inserisci un simbolo Binance, es. BTCUSDT'); return; }
      await loadSymbol(sym);
    });
    $('refresh').addEventListener('click', async ()=>{
      const sym = $('symbol').value.trim().toUpperCase();
      if(!sym){ alert('Nessun simbolo da aggiornare'); return; }
      await loadSymbol(sym);
    });
    async function loadSymbol(sym){
      $('status').textContent = `Carico ${sym}â€¦`;
      const itv = $('interval').value;
      try{
        const candles = await fetchBinance(sym, itv, 800);
        updateChartWithCandles(candles);
        $('status').textContent = `${sym} (${itv}) â€“ candele: ${candles.length}`;
      }catch(err){
        $('status').textContent = 'Errore: ' + err.message;
        alert('Simbolo non valido o rete non disponibile. Prova es. BTCUSDT');
      }
    }

    // -------- bootstrap --------
    initChart();
    $('symbol').value = 'BTCUSDT';
    loadSymbol('BTCUSDT'); // avvio con BTCUSDT
  </script>
</body>
</html>


