<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Trading Home â€“ Complete</title>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<style>
:root{
  --bg:#0b0f19; --panel:#121826; --text:#e5e7eb; --muted:#94a3b8;
  --bull:#22c55e; --bear:#ef4444; --accent:#38bdf8; --warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
     background:var(--bg); color:var(--text)}
header{position:sticky; top:0; z-index:10; background:#0b0f19cc; backdrop-filter: blur(8px);
       border-bottom:1px solid #1f2937}
.wrap{max-width:1120px; margin:0 auto; padding:16px}
h1{margin:6px 0 12px; font-size:28px}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.input{flex:1; min-width:220px; padding:12px 14px; border-radius:12px; border:1px solid #1f2937; background:var(--panel); color:var(--text)}
.btn{padding:12px 16px; border:0; border-radius:12px; background:var(--accent); color:#001018; font-weight:600; cursor:pointer}
.btn:disabled{opacity:.6; cursor:not-allowed}
.sel{padding:12px 14px; border-radius:12px; border:1px solid #1f2937; background:var(--panel); color:var(--text)}
.lang{padding:10px 12px; border-radius:12px; border:1px solid #1f2937; background:var(--panel); color:var(--text)}
.card{background:var(--panel); border:1px solid #1f2937; border-radius:16px; padding:16px}
.grid{display:grid; gap:16px}
@media(min-width:1000px){ .grid-2{grid-template-columns: 2fr 1fr} }
.muted{color:var(--muted); font-size:12px}
.kpi{display:flex; gap:10px; flex-wrap:wrap}
.pill{background:#0f172a; border:1px solid #1f2937; border-radius:999px; padding:8px 12px; font-size:12px}
.bad{color:var(--bear)} .good{color:var(--bull)} .warn{color:var(--warn)}
#chart{width:100%; height:460px}
a{color:#7dd3fc; text-decoration:none}
.news{display:grid; gap:10px}
.news-item{padding:10px; border-radius:12px; border:1px solid #1f2937; background:#0f172a}
.news-item b{display:block; margin-bottom:6px}
.tag{display:inline-block; padding:4px 8px; border:1px solid #1f2937; border-radius:999px; font-size:11px; margin-right:6px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h1 id="t_title">Trading Home â€“ Completa</h1>
      <select id="lang" class="lang">
        <option value="it">IT</option>
        <option value="en">EN</option>
        <option value="de">DE</option>
      </select>
    </div>
    <div class="row">
      <input id="symbol" class="input" placeholder="Simbolo Binance (es. BTCUSDT) / Parole chiave news"/>
      <select id="interval" class="sel">
        <option>1m</option><option>5m</option><option>15m</option>
        <option selected>1h</option><option>4h</option><option>1d</option>
      </select>
      <button id="search" class="btn">ðŸ”Ž <span data-i18n="search">Cerca</span></button>
      <button id="refresh" class="btn">â†» <span data-i18n="refresh">Aggiorna</span></button>
    </div>
    <div class="muted" id="t_note">Crypto live (Binance). Per altri asset: carica un CSV qui sotto.</div>
  </div>
</header>

<main class="wrap grid grid-2" style="padding-top:16px">
  <section class="card" style="grid-column:1 / -1">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <h3 style="margin:0" data-i18n="chart">Grafico</h3>
      <div class="muted" id="status">Pronto</div>
    </div>
    <div id="chart"></div>
    <div class="muted" style="margin-top:8px" id="legend">Candele â€¢ EMA20/50/200</div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px" data-i18n="prob">ProbabilitÃ  (didattica)</h3>
    <div class="kpi" style="margin-bottom:8px">
      <span class="pill"><span data-i18n="invest">Investire</span>: <b id="kpiBuy">â€”%</b></span>
      <span class="pill"><span data-i18n="disinvest">Disinvestire</span>: <b id="kpiSell">â€”%</b></span>
      <span class="pill"><span data-i18n="candles">Candele</span>: <b id="kpiCount">â€”</b></span>
    </div>
    <div id="signals" class="muted" style="margin:6px 0 10px"></div>
    <ul class="muted" style="line-height:1.6; margin:0; padding-left:18px">
      <li data-i18n="disclaimer">Stima educativa: trend + incroci EMA + pattern. Non Ã¨ consulenza finanziaria.</li>
    </ul>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px" data-i18n="news">Notizie finanziarie / geopolitiche</h3>
    <div class="row" style="margin-bottom:8px">
      <input id="newsQ" class="input" placeholder="Parole chiave (es. bitcoin OR btc, rate cuts, oil)"/>
      <button id="newsBtn" class="btn">ðŸ“° <span data-i18n="fetchnews">Carica notizie</span></button>
    </div>
    <div id="newsList" class="news"></div>
  </section>

  <section class="card" style="grid-column:1 / -1">
    <h3 style="margin:0 0 8px" data-i18n="csvtitle">Carica CSV (azioni/bond/commodities)</h3>
    <input type="file" id="csv" accept=".csv" />
    <div class="muted" style="margin-top:8px" id="csvhelp">
      Formato: <code>timestamp,open,high,low,close,volume</code> (ms o data ISO). Dati elaborati localmente.
    </div>
  </section>
</main>

<script>
/* ===== i18n base ===== */
const I18N = {
  it:{search:"Cerca",refresh:"Aggiorna",chart:"Grafico",prob:"ProbabilitÃ  (didattica)",
      invest:"Investire",disinvest:"Disinvestire",candles:"Candele",
      disclaimer:"Stima educativa: trend + incroci EMA + pattern. Non Ã¨ consulenza finanziaria.",
      news:"Notizie finanziarie / geopolitiche",fetchnews:"Carica notizie",
      csvtitle:"Carica CSV (azioni/bond/commodities)"},
  en:{search:"Search",refresh:"Refresh",chart:"Chart",prob:"Probabilities (educational)",
      invest:"Invest",disinvest:"Divest",candles:"Candles",
      disclaimer:"Educational estimate: trend + EMA crosses + patterns. Not investment advice.",
      news:"Financial / geopolitical news",fetchnews:"Fetch news",
      csvtitle:"Upload CSV (stocks/bonds/commodities)"},
  de:{search:"Suchen",refresh:"Aktualisieren",chart:"Chart",prob:"Wahrscheinlichkeiten (Lernen)",
      invest:"Investieren",disinvest:"Desinvestieren",candles:"Kerzen",
      disclaimer:"Didaktische SchÃ¤tzung: Trend + EMA-Kreuzungen + Muster. Keine Anlageberatung.",
      news:"Finanz-/Geopolitik-News",fetchnews:"News laden",
      csvtitle:"CSV hochladen (Aktien/Anleihen/Rohstoffe)"}
};
const $ = (id)=>document.getElementById(id);
function setLang(l){
  const dict = I18N[l] || I18N.it;
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k = el.getAttribute("data-i18n");
    if(dict[k]) el.textContent = dict[k];
  });
  $("t_title").textContent = l==="it" ? "Trading Home â€“ Completa" :
                             l==="en" ? "Trading Home â€“ Complete" : "Trading Home â€“ VollstÃ¤ndig";
  $("t_note").textContent = l==="it" ? "Crypto live (Binance). Per altri asset: carica un CSV qui sotto."
                       : l==="en" ? "Live crypto (Binance). For other assets: upload a CSV below."
                                  : "Live-Krypto (Binance). FÃ¼r andere Assets: CSV unten hochladen.";
}
$("lang").addEventListener("change", e=>setLang(e.target.value));
setLang("it");

/* ===== EMA & helpers ===== */
function ema(values, period){
  const k = 2/(period+1); const out=[]; let prev;
  for(let i=0;i<values.length;i++){
    const v=values[i];
    if(i<period-1){ out.push(null); }
    else if(i===period-1){ const sma=avg(values.slice(0,period)); out.push(sma); prev=sma; }
    else { const n=v*k + prev*(1-k); out.push(n); prev=n; }
  }
  return out;
}
const avg = arr=>arr.reduce((a,b)=>a+b,0)/arr.length;
function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

/* ===== Chart ===== */
let chart, lastCandles=[];
function initChart(){
  const opts = {
    chart:{ type:'candlestick', height:460, background:'#121826', foreColor:'#e5e7eb',
            animations:{enabled:true},
            toolbar:{show:true, tools:{pan:true, zoom:true, zoomin:true, zoomout:true, reset:true}},
            zoom:{enabled:true}},
    theme:{mode:'dark'},
    series:[],
    xaxis:{ type:'datetime' },
    yaxis:{ tooltip:{enabled:true}, decimalsInFloat:2 },
    grid:{ borderColor:'#1f2937' },
    plotOptions:{ candlestick:{ colors:{ upward:getCSS('--bull'), downward:getCSS('--bear') }, wick:{useFillColor:true} } },
    title:{ text:'', align:'left', style:{color:'#e5e7eb'} }
  };
  chart = new ApexCharts($("#chart"), opts);
  chart.render();
}
function toApexSeries(c){ return c.map(k=>({x:new Date(k.time*1000), y:[k.open,k.high,k.low,k.close]})); }
function updateChart(candles){
  lastCandles = candles.slice();
  const closes = candles.map(c=>c.close);
  const e20 = ema(closes,20), e50=ema(closes,50), e200=ema(closes,200);
  chart.updateSeries([
    {name:"Candele", type:"candlestick", data: toApexSeries(candles)},
    {name:"EMA20", type:"line", data: candles.map((c,i)=>({x:new Date(c.time*1000), y:e20[i]??null})), color:getCSS('--accent')},
    {name:"EMA50", type:"line", data: candles.map((c,i)=>({x:new Date(c.time*1000), y:e50[i]??null})), color:'#9aa7ff'},
    {name:"EMA200", type:"line", data: candles.map((c,i)=>({x:new Date(c.time*1000), y:e200[i]??null})), color:'#f59e0b'},
  ], true);
  updateKPIs(candles, e20, e50);
  detectPatterns(candles); // aggiorna segnali
}

/* ===== KPIs ===== */
function updateKPIs(candles, e20, e50){
  $("kpiCount").textContent = candles.length;
  if(candles.length<5){ $("kpiBuy").textContent="â€”%"; $("kpiSell").textContent="â€”%"; return; }
  const first = candles[0].close, last = candles.at(-1).close;
  const perf = ((last-first)/first)*100;
  // bonus/malus incrocio EMA20/EMA50 recente
  const idx = e50.findLastIndex(v=>v!=null);
  let bonus=0;
  if(idx>0 && e20[idx]!=null && e50[idx]!=null){
    const up = e20[idx] > e50[idx] && e20[idx-1] <= e50[idx-1];
    const dn = e20[idx] < e50[idx] && e20[idx-1] >= e50[idx-1];
    if(up) bonus+=8;
    if(dn) bonus-=8;
  }
  const buy = Math.max(5, Math.min(95, 50 + perf*0.6 + bonus));
  $("kpiBuy").textContent  = buy.toFixed(0)+"%";
  $("kpiSell").textContent = (100-buy).toFixed(0)+"%";
}

/* ===== Pattern detection (semplice) ===== */
function localExtrema(arr, look=3){
  const tops=[], bots=[];
  for(let i=look;i<arr.length-look;i++){
    const left = arr.slice(i-look,i), right = arr.slice(i+1,i+1+look);
    const v = arr[i];
    if(left.every(x=>x<v) && right.every(x=>x<v)) tops.push(i);
    if(left.every(x=>x>v) && right.every(x=>x>v)) bots.push(i);
  }
  return {tops,bots};
}
function detectPatterns(c){
  const closes = c.map(k=>k.close);
  const {tops,bots} = localExtrema(closes, 3);
  let notes=[];
  // Double Top / Bottom
  for(let i=0;i<tops.length-1;i++){
    const a=tops[i], b=tops[i+1];
    const near = Math.abs(closes[a]-closes[b]) / ((closes[a]+closes[b])/2) < 0.01;
    const sep = b-a >= 5;
    if(near && sep) notes.push(`<span class="bad">Double Top</span> vicino a ${c[b].time*1000}`);
  }
  for(let i=0;i<bots.length-1;i++){
    const a=bots[i], b=bots[i+1];
    const near = Math.abs(closes[a]-closes[b]) / ((closes[a]+closes[b])/2) < 0.01;
    const sep = b-a >= 5;
    if(near && sep) notes.push(`<span class="good">Double Bottom</span> vicino a ${c[b].time*1000}`);
  }
  // Head & Shoulders (grezzo)
  for(let i=2;i<tops.length-2;i++){
    const L=tops[i-1], H=tops[i], R=tops[i+1];
    if(closes[H] > closes[L]*1.01 && closes[H] > closes[R]*1.01){
      notes.push(`<span class="bad">Testa-Spalle</span> area ${c[H].time*1000}`);
    }
  }
  // Output leggibile
  if(notes.length===0){ $("signals").innerHTML = "Pattern: nessun segnale evidente."; return; }
  $("signals").innerHTML = "Pattern: " + notes.map(n=>`<span class="tag">${n}</span>`).join(" ");
}

/* ===== Binance live ===== */
async function fetchBinance(sym, interval='1h', limit=800){
  const url = `https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(sym)}&interval=${interval}&limit=${limit}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("Binance error");
  const data = await r.json();
  return data.map(d=>({
    time: Math.floor(d[0]/1000),
    open: +d[1], high:+d[2], low:+d[3], close:+d[4], volume:+d[5]
  }));
}

/* ===== CSV ===== */
function parseCSV(text){
  const L = text.trim().split(/\r?\n/);
  const H = L[0].split(',').map(s=>s.trim().toLowerCase());
  const idx = {
    t:H.findIndex(h=>["timestamp","date","time","t"].includes(h)),
    o:H.findIndex(h=>["open","o"].includes(h)),
    h:H.findIndex(h=>["high","h"].includes(h)),
    l:H.findIndex(h=>["low","l"].includes(h)),
    c:H.findIndex(h=>["close","c"].includes(h)),
    v:H.findIndex(h=>["volume","v"].includes(h)),
  };
  const out=[];
  for(let i=1;i<L.length;i++){
    const cols=L[i].split(',');
    if(cols.length<5) continue;
    const tsRaw = cols[idx.t];
    const ts = /^\d{10,13}$/.test(tsRaw) ? Math.floor(Number(tsRaw)/1000) : Math.floor(new Date(tsRaw).getTime()/1000);
    out.push({time:ts, open:+cols[idx.o], high:+cols[idx.h], low:+cols[idx.l], close:+cols[idx.c], volume: idx.v>=0 ? +cols[idx.v] : undefined});
  }
  return out.sort((a,b)=>a.time-b.time);
}

/* ===== News (GDELT) ===== */
async function fetchNews(q, lang='it', max=10){
  // query semplice: GDELT 2.1 DOC API
  const query = encodeURIComponent(q || $("symbol").value || "markets");
  const url = `https://api.gdeltproject.org/api/v2/doc/doc?query=${query}&mode=ArtList&maxrecords=${max}&format=json`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("GDELT error");
  const js = await r.json();
  return (js?.articles||[]).map(a=>({
    title: a.title, url: a.url, source: a.sourceCountry || a.domain,
    lang: a.language, datetime: a.seendate
  }));
}
function scoreSentiment(title){
  const t = title.toLowerCase();
  const pos = ["beat","surge","rally","upgrade","record","growth","bull","accelera","sale","utili in crescita","forte"];
  const neg = ["drop","selloff","downgrade","miss","crash","war","probe","fine","indagine","taglio posti","debole"];
  let s=0; pos.forEach(w=>{ if(t.includes(w)) s+=1; }); neg.forEach(w=>{ if(t.includes(w)) s-=1; });
  return s; // -N..+N
}
function renderNews(items){
  const box = $("newsList"); box.innerHTML="";
  if(items.length===0){ box.innerHTML = `<div class="muted">Nessuna notizia trovata.</div>`; return; }
  items.forEach(it=>{
    const s = scoreSentiment(it.title);
    const cls = s>0 ? "good" : s<0 ? "bad" : "muted";
    const tag = s>0 ? "positivo" : s<0 ? "negativo" : "neutro";
    const div = document.createElement("div");
    div.className = "news-item";
    div.innerHTML = `<b class="${cls}">${it.title}</b>
      <div class="muted">${it.source||""} â€¢ ${it.lang||""}</div>
      <div style="margin-top:6px"><span class="tag ${cls}">${tag}</span>
      <a href="${it.url}" target="_blank" rel="noopener">Apri</a></div>`;
    box.appendChild(div);
  });
}

/* ===== UI ===== */
async function loadSymbol(sym){
  $("status").textContent = `Carico ${sym}â€¦`;
  try{
    const itv = $("interval").value;
    const candles = await fetchBinance(sym, itv, 800);
    updateChart(candles);
    $("status").textContent = `${sym} (${itv}) â€“ candele: ${candles.length}`;
  }catch(e){
    $("status").textContent = "Errore: " + e.message;
    alert("Simbolo non valido o rete non disponibile. Esempio: BTCUSDT");
  }
}
$("search").addEventListener("click", ()=> loadSymbol($("symbol").value.trim().toUpperCase() || "BTCUSDT"));
$("refresh").addEventListener("click", ()=> {
  const sym = $("symbol").value.trim().toUpperCase() || "BTCUSDT";
  loadSymbol(sym);
});
$("csv").addEventListener("change", async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  $("status").textContent="Carico CSVâ€¦";
  try{
    const text = await f.text();
    const rows = parseCSV(text);
    if(rows.length<20) throw new Error("CSV troppo corto o colonne errate");
    updateChart(rows);
    $("status").textContent=`CSV caricato: ${rows.length} candele`;
  }catch(err){
    $("status").textContent="Errore CSV: "+err.message;
    alert(err.message);
  }
});
$("newsBtn").addEventListener("click", async ()=>{
  try{
    $("newsList").innerHTML = `<div class="muted">Caricoâ€¦</div>`;
    const items = await fetchNews($("newsQ").value.trim());
    renderNews(items);
  }catch(e){
    $("newsList").innerHTML = `<div class="muted">Errore caricamento news.</div>`;
  }
});

/* ===== Boot ===== */
initChart();
$("symbol").value = "BTCUSDT";
loadSymbol("BTCUSDT");
</script>
</body>
</html>

