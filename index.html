<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Trading Home â€” Universale</title>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<style>
:root{--bg:#0b0f19;--panel:#121826;--text:#e5e7eb;--muted:#94a3b8;--bull:#22c55e;--bear:#ef4444;--accent:#38bdf8;--warn:#f59e0b}
*{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:10;background:#0b0f19cc;backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
.wrap{max-width:1120px;margin:0 auto;padding:12px}
h1{margin:6px 0 10px;font-size:26px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,.sel,.lang{padding:12px 14px;border-radius:12px;border:1px solid #1f2937;background:var(--panel);color:var(--text)}
.input{flex:1;min-width:180px}
.btn{padding:12px 16px;border:0;border-radius:12px;background:var(--accent);color:#001018;font-weight:600;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:12px}
.grid{display:grid;gap:12px} @media (min-width:980px){ .grid-2{grid-template-columns:2fr 1fr} }
.muted{color:var(--muted);font-size:12px}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.pill{background:#0f172a;border:1px solid #1f2937;border-radius:999px;padding:8px 10px;font-size:12px}
.bad{color:var(--bear)} .good{color:var(--bull)} .warn{color:var(--warn)}
#chart,#rsiChart,#macdChart{width:100%} #chart{height:440px} #rsiChart{height:160px} #macdChart{height:180px}
.news{display:grid;gap:8px} .news-item{padding:10px;border-radius:12px;border:1px solid #1f2937;background:#0f172a}
.news-item b{display:block;margin-bottom:6px} .tag{display:inline-block;padding:4px 8px;border:1px solid #1f2937;border-radius:999px;font-size:11px;margin-right:6px}
.toggle{display:flex;align-items:center;gap:6px}
@media (max-width:480px){ h1{font-size:22px} #chart{height:360px} }/* ====== Migliorie per smartphone ====== */
@media (max-width: 768px) {
  /* Tipografia & spazi */
  html, body { font-size: 16px; }
  h1 { font-size: 22px; line-height: 1.25; }
  .wrap { padding: 10px; }
  .row { gap: 10px; }

  /* Input e pulsanti piÃ¹ grandi (touch-friendly) */
  .input, .sel, .lang {
    padding: 14px 16px;
    font-size: 16px;         /* evita lo zoom automatico su iOS */
    min-height: 44px;        /* target minimo consigliato */
  }
  .btn {
    padding: 12px 16px;
    font-size: 16px;
    min-height: 44px;
    border-radius: 14px;
  }

  /* Griglia: passa a 1 colonna */
  .grid-2 { grid-template-columns: 1fr !important; }

  /* Campi in riga che vanno a capo bene */
  .input { flex: 1 1 100%; min-width: 0; }
  .sel { flex: 0 0 auto; }

  /* Grafici piÃ¹ alti e leggibili */
  #chart    { height: 520px; }
  #rsiChart { height: 200px; }
  #macdChart{ height: 220px; }

  /* Tooltip, menu e label ApexCharts piÃ¹ grandi */
  .apexcharts-tooltip,
  .apexcharts-menu,
  .apexcharts-legend-text,
  .apexcharts-xaxis text,
  .apexcharts-yaxis text {
    font-size: 14px !important;
  }
  .apexcharts-toolbar {
    transform: scale(1.15);             /* ingrandisce icone zoom/pan */
    transform-origin: top right;
  }
}

/* Schermi piccoli piccoli (telefoni < 420px) */
@media (max-width: 420px) {
  h1 { font-size: 20px; }
  #chart    { height: 560px; }
  #rsiChart { height: 220px; }
  #macdChart{ height: 240px; }
  .btn { padding: 12px 14px; }
}

</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1 id="t_title">Trading Home â€” Universale</h1>
      <select id="lang" class="lang">
        <option value="it">IT</option><option value="en">EN</option><option value="de">DE</option>
      </select>
    </div>
    <div class="row">
      <input id="symbol" class="input" placeholder="Scrivi: DEMO, oro, BTCUSDT, EURUSD, AAPL, ^SPXâ€¦"/>
      <select id="interval" class="sel" title="Intervallo (solo crypto Binance)">
        <option>1m</option><option>5m</option><option>15m</option>
        <option selected>1h</option><option>4h</option><option>1d</option>
      </select>
      <button id="search" class="btn">ðŸ”Ž <span data-i18n="search">Cerca</span></button>
      <button id="refresh" class="btn">â†» <span data-i18n="refresh">Aggiorna</span></button>
    </div>
    <div class="row" style="margin-top:6px">
      <label class="toggle"><input type="checkbox" id="togglePatterns" checked/>
        <span class="muted" data-i18n="showpat">Mostra pattern</span></label>
      <div class="muted" id="t_note" style="margin-left:auto">
        Demo allâ€™avvio â€¢ Crypto (intraday) via Binance â€¢ Altri mercati (daily) via Stooq
      </div>
    </div>
  </div>
</header>

<main class="wrap grid grid-2" style="padding-top:12px">
  <section class="card" style="grid-column:1/-1">
    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <div class="muted" id="status">Avvioâ€¦</div>
    </div>
    <div id="chart"></div>
    <div id="rsiChart" style="margin-top:8px"></div>
    <div id="macdChart" style="margin-top:8px"></div>
    <div class="muted" style="margin-top:6px">Candele â€¢ EMA20/50/200 â€¢ RSI(14) â€¢ MACD(12,26,9)</div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px" data-i18n="prob">ProbabilitÃ  (didattica)</h3>
    <div class="kpi" style="margin-bottom:8px">
      <span class="pill"><span data-i18n="invest">Investire</span>: <b id="kpiBuy">â€”%</b></span>
      <span class="pill"><span data-i18n="disinvest">Disinvestire</span>: <b id="kpiSell">â€”%</b></span>
      <span class="pill"><span data-i18n="candles">Candele</span>: <b id="kpiCount">â€”</b></span>
    </div>
    <div id="signals" class="muted" style="margin:6px 0 10px"></div>
    <ul class="muted" style="line-height:1.6;margin:0;padding-left:18px">
      <li data-i18n="disclaimer">Stima educativa: trend + incroci EMA + pattern. Non Ã¨ consulenza finanziaria.</li>
    </ul>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px" data-i18n="news">Notizie finanziarie / geopolitiche</h3>
    <div class="row" style="margin-bottom:8px">
      <input id="newsQ" class="input" placeholder="es. bitcoin OR btc, rate cuts, oil"/>
      <button id="newsBtn" class="btn">ðŸ“° <span data-i18n="fetchnews">Carica notizie</span></button>
    </div>
    <div id="newsList" class="news"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h3 style="margin:0 0 8px" data-i18n="csvtitle">Carica CSV (azioni/bond/commodities)</h3>
    <input type="file" id="csv" accept=".csv"/>
    <div class="muted" style="margin-top:8px" id="csvhelp">
      Formato: <code>timestamp,open,high,low,close,volume</code> (ms o data ISO). Elaborazione locale.
    </div>
  </section>
</main>

<script>
window.addEventListener("DOMContentLoaded", () => {
/* ---------- util & debug ---------- */
const $=id=>document.getElementById(id);
const STATUS=msg=>{ try{$("status").textContent=msg;}catch{} };
window.onerror=(m)=>{ STATUS("Errore JS: "+m); alert("Errore JS: "+m); return true; };
window.addEventListener("unhandledrejection",e=>{ STATUS("Errore rete: "+(e.reason?.message||e.reason)); });

/* ---------- i18n minimo ---------- */
const I18N={it:{search:"Cerca",refresh:"Aggiorna",prob:"ProbabilitÃ  (didattica)",invest:"Investire",disinvest:"Disinvestire",
candles:"Candele",disclaimer:"Stima educativa: trend + incroci EMA + pattern. Non Ã¨ consulenza finanziaria.",
news:"Notizie finanziarie / geopolitiche",fetchnews:"Carica notizie",csvtitle:"Carica CSV (azioni/bond/commodities)",showpat:"Mostra pattern"},
en:{search:"Search",refresh:"Refresh",prob:"Probabilities (educational)",invest:"Invest",disinvest:"Divest",
candles:"Candles",disclaimer:"Educational estimate: trend + EMA crosses + patterns. Not investment advice.",
news:"Financial / geopolitical news",fetchnews:"Fetch news",csvtitle:"Upload CSV (stocks/bonds/commodities)",showpat:"Show patterns"}};
function setLang(l){const d=I18N[l]||I18N.it;document.querySelectorAll("[data-i18n]").forEach(el=>{const k=el.dataset.i18n;if(d[k]) el.textContent=d[k];});$("t_title").textContent=l==="it"?"Trading Home â€” Universale":"Trading Home â€” Universal";}
$("lang").addEventListener("change",e=>{setLang(e.target.value);savePrefs();}); setLang("it");

/* ---------- math & ind ---------- */
const avg=a=>a.reduce((x,y)=>x+y,0)/a.length;
function ema(v,p){const k=2/(p+1),o=[];let prev;for(let i=0;i<v.length;i++){const x=v[i];if(i<p-1)o.push(null);else if(i===p-1){const s=avg(v.slice(0,p));o.push(s);prev=s;}else{const n=x*k+prev*(1-k);o.push(n);prev=n;}}return o;}
function rsi(c,p=14){const o=[];let g=0,l=0;for(let i=1;i<c.length;i++){const ch=c[i]-c[i-1];if(i<=p){if(ch>0)g+=ch;else l-=ch;o.push(null);continue}const G=(g+(ch>0?ch:0))/p,L=(l+(ch<0?-ch:0))/p;g=G*p;l=L*p;const rs=L===0?100:G/L;o.push(100-(100/(1+rs)));}return o;}
function macd(c,f=12,s=26,sg=9){const F=ema(c,f),S=ema(c,s);const L=c.map((_,i)=>(F[i]!=null&&S[i]!=null)?F[i]-S[i]:null);const Sig=ema(L.map(v=>v??0),sg).map((v,i)=>L[i]==null?null:v);const H=L.map((v,i)=>(v==null||Sig[i]==null)?null:(v-Sig[i]));return{macdLine:L,signal:Sig,hist:H};}
const getCSS=v=>getComputedStyle(document.documentElement).getPropertyValue(v).trim();
const fmt=ts=>new Date(ts*1000).toLocaleString('it-IT',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'});

/* ---------- charts ---------- */
let chart,rsiChart,macdChart,lastCandles=[];
function baseChartOpts(){return{chart:{type:'candlestick',height:440,background:'#121826',foreColor:'#e5e7eb',
toolbar:{show:true,tools:{pan:true,zoom:true,zoomin:true,zoomout:true,reset:true}},zoom:{enabled:true}},
theme:{mode:'dark'},series:[],xaxis:{type:'datetime'},yaxis:{tooltip:{enabled:true},decimalsInFloat:2},
grid:{borderColor:'#1f2937'},plotOptions:{candlestick:{colors:{upward:getCSS('--bull'),downward:getCSS('--bear')},wick:{useFillColor:true}}}};}
function initCharts(){
  chart=new ApexCharts($("chart"),baseChartOpts()); chart.render();
  rsiChart=new ApexCharts($("rsiChart"),{chart:{type:'line',height:160,background:'#121826',foreColor:'#e5e7eb',toolbar:{show:false}},
  theme:{mode:'dark'},series:[],xaxis:{type:'datetime'},yaxis:{min:0,max:100,tickAmount:5},
  annotations:{yaxis:[{y:70,borderColor:'#ef4444'},{y:30,borderColor:'#22c55e'}]},grid:{borderColor:'#1f2937'}}); rsiChart.render();
  macdChart=new ApexCharts($("macdChart"),{chart:{type:'line',height:180,background:'#121826',foreColor:'#e5e7eb',toolbar:{show:false}},
  theme:{mode:'dark'},series:[],xaxis:{type:'datetime'},yaxis:{decimalsInFloat:4},grid:{borderColor:'#1f2937'}}); macdChart.render();
}
const toSeries=c=>c.map(k=>({x:new Date(k.time*1000),y:[k.open,k.high,k.low,k.close]}));
function updateAllCharts(c){
  lastCandles=c.slice(); const closes=c.map(x=>x.close);
  const e20=ema(closes,20),e50=ema(closes,50),e200=ema(closes,200);
  chart.updateSeries([
    {name:'Candele',type:'candlestick',data:toSeries(c)},
    {name:'EMA20',type:'line',data:c.map((k,i)=>({x:new Date(k.time*1000),y:e20[i]})),color:getCSS('--accent')},
    {name:'EMA50',type:'line',data:c.map((k,i)=>({x:new Date(k.time*1000),y:e50[i]})),color:'#9aa7ff'},
    {name:'EMA200',type:'line',data:c.map((k,i)=>({x:new Date(k.time*1000),y:e200[i]})),color:'#f59e0b'}
  ],true);
  const r=rsi(closes,14); rsiChart.updateSeries([{name:'RSI(14)',data:c.map((k,i)=>({x:new Date(k.time*1000),y:r[i]}))}],true);
  const {macdLine,signal,hist}=macd(closes,12,26,9);
  macdChart.updateSeries([
    {name:'MACD',data:c.map((k,i)=>({x:new Date(k.time*1000),y:macdLine[i]}))},
    {name:'Signal',data:c.map((k,i)=>({x:new Date(k.time*1000),y:signal[i]}))},
    {name:'Histogram',type:'bar',data:c.map((k,i)=>({x:new Date(k.time*1000),y:hist[i]}))}
  ],true);
  updateKPIs(c,e20,e50);
  if($("togglePatterns").checked) detectPatterns(c); else $("signals").innerHTML="";
}

/* ---------- KPI & pattern ---------- */
function updateKPIs(c,e20,e50){
  $("kpiCount").textContent=c.length;
  if(c.length<5){$("kpiBuy").textContent="â€”%";$("kpiSell").textContent="â€”%";return;}
  const f=c[0].close,l=c.at(-1).close; const perf=((l-f)/f)*100;
  const idx=e50.findLastIndex(v=>v!=null); let bonus=0;
  if(idx>0&&e20[idx]!=null&&e50[idx]!=null){
    const up=e20[idx]>e50[idx]&&e20[idx-1]<=e50[idx-1];
    const dn=e20[idx]<e50[idx]&&e20[idx-1]>=e50[idx-1];
    if(up)bonus+=8; if(dn)bonus-=8;
  }
  const buy=Math.max(5,Math.min(95,50+perf*0.6+bonus));
  $("kpiBuy").textContent=buy.toFixed(0)+"%";
  $("kpiSell").textContent=(100-buy).toFixed(0)+"%";
}
function localExtremaWithStrength(a,look=3){
  const tops=[],bots=[];
  for(let i=look;i<a.length-look;i++){
    const L=a.slice(i-look,i),R=a.slice(i+1,i+1+look),v=a[i];
    const isTop=L.every(x=>x<v)&&R.every(x=>x<v), isBot=L.every(x=>x>v)&&R.every(x=>x>v);
    if(isTop){const n=Math.max(Math.max(...L),Math.max(...R));tops.push({i,strength:(v-n)/Math.max(1e-9,n)});}
    if(isBot){const n=Math.min(Math.min(...L),Math.min(...R));bots.push({i,strength:(n-v)/Math.max(1e-9,v)});}
  } return {tops,bots};
}
function detectPatterns(c){
  const closes=c.map(k=>k.close);
  const {tops,bots}=localExtremaWithStrength(closes,3);
  const mean=avg(closes.slice(-Math.min(200,closes.length)));
  const tol=0.0075,minSep=8,maxS=6; const signals=[];
  for(let a=0;a<tops.length-1;a++)for(let b=a+1;b<tops.length;b++){
    const i=tops[a].i,j=tops[b].i; if(j-i<minSep)continue;
    const near=Math.abs(closes[i]-closes[j])/((closes[i]+closes[j])/2)<=tol; if(!near)continue;
    const midMin=Math.min(...closes.slice(i+1,j));
    const necklineOk=(Math.max(closes[i],closes[j])-midMin)/mean>0.004; if(!necklineOk)continue;
    const score=(tops[a].strength+tops[b].strength)+(j-i)*0.001;
    signals.push({type:'Double Top',idx:j,score,ts:c[j].time}); break;
  }
  for(let a=0;a<bots.length-1;a++)for(let b=a+1;b<bots.length;b++){
    const i=bots[a].i,j=bots[b].i; if(j-i<minSep)continue;
    const near=Math.abs(closes[i]-closes[j])/((closes[i]+closes[j])/2)<=tol; if(!near)continue;
    const midMax=Math.max(...closes.slice(i+1,j));
    const necklineOk=(midMax-Math.min(closes[i],closes[j]))/mean>0.004; if(!necklineOk)continue;
    const score=Math.abs(bots[a].strength+bots[b].strength)+(j-i)*0.001;
    signals.push({type:'Double Bottom',idx:j,score,ts:c[j].time}); break;
  }
  for(let k=1;k<tops.length-1;k++){
    const L=tops[k-1].i,H=tops[k].i,R=tops[k+1].i; if(R-L<minSep)continue;
    const headHigher=closes[H]>closes[L]*1.01&&closes[H]>closes[R]*1.01;
    const shouldersNear=Math.abs(closes[L]-closes[R])/((closes[L]+closes[R])/2)<=0.015;
    if(headHigher&&shouldersNear){
      const score=(tops[k].strength-Math.abs(tops[k-1].strength-tops[k+1].strength)*0.2);
      signals.push({type:'Testa-Spalle',idx:H,score,ts:c[H].time});
    }
  }
  signals.sort((a,b)=>b.score-a.score);
  const picked=[]; for(const s of signals){ if(picked.length>=maxS)break; if(picked.some(p=>Math.abs(p.idx-s.idx)<12&&p.type===s.type))continue; picked.push(s); }
  $("signals").innerHTML = picked.length===0 ? "Pattern: nessun segnale evidente."
    : "Pattern: "+picked.map(s=>`<span class="tag ${s.type.includes('Top')?'bad':s.type.includes('Bottom')?'good':'warn'}">${s.type} â€” ${fmt(s.ts)}</span>`).join(" ");
}

/* ---------- mapping alias ---------- */
function clean(s){return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase().replace(/\s+/g,"").replace(/\//g,"").replace(/(.)\1{2,}/g,"$1$1");}
const IT_SYNONYMS={DOLLARO:"EURUSD",EURO:"EURUSD",STERLINA:"GBPUSD",YEN:"USDJPY",FRANCO:"USDCHF",ORO:"XAUUSD",ARGENTO:"XAGUSD",PETROLIO:"BRENT",WTI:"WTI",NASDAQ:"^NDQ",SP500:"^SPX","S&P500":"^SPX",SNP500:"^SPX",INDICESP500:"^SPX",DAX:"^DAX",FTSEMIB:"^FTMIB",MIB:"^FTMIB",FTSE100:"^FTSE"};
const ALIAS={BITCOIN:"BTCUSDT",BTC:"BTCUSDT",ETHEREUM:"ETHUSDT",ETH:"ETHUSDT",AAPL:"AAPL",SPX:"^SPX","^SPX":"^SPX","^NDQ":"^NDQ"};
function detectSource(raw){
  let q=clean(raw);
  if(q==="DEMO") return {src:"demo",symbol:"demo"};
  if(IT_SYNONYMS[q]) q=IT_SYNONYMS[q];
  if(ALIAS[q]) q=ALIAS[q];
  if(/^[A-Z0-9]+USDT$/.test(q)) return {src:"binance",symbol:q}; // crypto
  let sym=q.toLowerCase();
  if(/^[a-z]{6}$/.test(sym)) return {src:"stooq",symbol:sym};   // forex
  if(/^\^/.test(q)) return {src:"stooq",symbol:q.toLowerCase()};// indici
  if(/(brent|wti|xauusd|xagusd)/i.test(sym)) return {src:"stooq",symbol:sym};// commodities
  if(/^[a-z]{1,6}$/.test(sym)) sym+=".us";                       // default azioni USA
  return {src:"stooq",symbol:sym};
}

/* ---------- fetch con timeout & fallback ---------- */
function withTimeout(promise, ms=8000){
  return Promise.race([promise,new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),ms))]);
}
async function j(url){const r=await fetch(url,{cache:"no-store"});if(!r.ok)throw new Error("HTTP "+r.status);return r.json();}
async function t(url){const r=await fetch(url,{cache:"no-store"});if(!r.ok)throw new Error("HTTP "+r.status);return r.text();}

async function fetchBinanceCandles(symbol, interval='1h', limit=800){
  const q=`symbol=${encodeURIComponent(symbol)}&interval=${interval}&limit=${limit}`;
  const tries=[
    {type:"json",url:`https://data-api.binance.vision/api/v3/klines?${q}`},
    {type:"json",url:`https://cors.isomorphic-git.org/https://api.binance.com/api/v3/klines?${q}`},
    {type:"text",url:`https://api.allorigins.win/raw?url=${encodeURIComponent('https://api.binance.com/api/v3/klines?'+q)}`}
  ];
  let data=null;
  for(const tr of tries){
    try{
      data = tr.type==="json" ? await withTimeout(j(tr.url),8000)
                              : JSON.parse(await withTimeout(t(tr.url),8000));
      if(Array.isArray(data)&&data.length) break;
    }catch(_){}
  }
  if(!data||!Array.isArray(data)||!data.length) throw new Error("Binance non raggiungibile");
  return data.map(k=>({time:Math.floor(k[0]/1000),open:+k[1],high:+k[2],low:+k[3],close:+k[4],volume:+k[5]}));
}
async function fetchTextWithFallback(urls){
  for(const u of urls){
    try{
      let s=await withTimeout(t(u),8000);
      s=s.replace(/<[^>]+>/g,"\n").replace(/\r\n/g,"\n").replace(/\r/g,"\n");
      const i=s.search(/(^|\n)\s*Date\s*,\s*Open\s*,\s*High\s*,\s*Low\s*,\s*Close/i);
      if(i>=0){ s=s.slice(i).trim(); if(/^Date\s*,\s*Open\s*,\s*High\s*,\s*Low\s*,\s*Close/i.test(s.split("\n")[0])) return s; }
    }catch(_){}
  } throw new Error("Stooq non disponibile");
}
async function fetchStooqDaily(symbol,limit=800){
  const path=`q/d/l/?s=${encodeURIComponent(symbol)}&i=d`;
  const s=await fetchTextWithFallback([
    `https://stooq.com/${path}`,
    `https://stooq.pl/${path}`,
    `https://r.jina.ai/http://stooq.com/${path}`,
    `https://r.jina.ai/http://stooq.pl/${path}`
  ]);
  const lines=s.trim().split("\n"); let start=0;
  for(let i=0;i<lines.length;i++){ if(/^\s*Date\s*,\s*Open\s*,\s*High\s*,\s*Low\s*,\s*Close/i.test(lines[i])){start=i+1;break;} }
  const out=[]; for(let i=start;i<lines.length;i++){
    const row=lines[i].trim(); if(!row) continue; const c=row.split(","); if(c.length<5) continue;
    const [DateStr,Open,High,Low,Close,Volume]=c.map(s=>s.trim());
    if(!/^\d{4}-\d{2}-\d{2}$/.test(DateStr)) continue;
    const ts=Math.floor(new Date(DateStr+"T00:00:00Z").getTime()/1000);
    out.push({time:ts,open:+Open,high:+High,low:+Low,close:+Close,volume:Volume?+Volume:0});
  }
  if(!out.length) throw new Error("Nessun dato valido da Stooq");
  return out.sort((a,b)=>a.time-b.time).slice(-limit);
}
function genDemo(n=500,start=20000){
  const out=[]; let c=start,o=start;
  for(let i=0;i<n;i++){
    const vol=Math.max(5,Math.abs(o)*0.02);
    const dir=(Math.random()-0.5)*vol;
    c=Math.max(1,o+dir); const h=c+vol*0.6, l=Math.max(1,c-vol*0.6);
    out.push({time:Math.floor((Date.now()/1000)-(n-i)*3600),open:o,high:h,low:l,close:c,volume:1000});
    o=c;
  } return out;
}
async function fetchUniversal(raw){
  const {src,symbol}=detectSource(raw);
  if(src==="demo") return genDemo(500,20000);
  if(src==="binance"){ const itv=$("interval").value; return await fetchBinanceCandles(symbol,itv,800); }
  return await fetchStooqDaily(symbol,800);
}

/* ---------- News & CSV ---------- */
async function fetchNews(q,max=10){const query=encodeURIComponent(q||$("symbol").value||"markets");
  const url=`https://api.gdeltproject.org/api/v2/doc/doc?query=${query}&mode=ArtList&maxrecords=${max}&format=json`;
  const r=await fetch(url); if(!r.ok) throw new Error("GDELT error"); const js=await r.json();
  return (js?.articles||[]).map(a=>({title:a.title,url:a.url,source:a.sourceCountry||a.domain,lang:a.language,datetime:a.seendate}));
}
function scoreSentiment(t){t=t.toLowerCase();const pos=["beat","surge","rally","upgrade","record","growth","bull","accelera","sale","utile","forte"],neg=["drop","selloff","downgrade","miss","crash","war","probe","fine","indagine","taglio","debole"];let s=0;pos.forEach(w=>t.includes(w)&&(s+=1));neg.forEach(w=>t.includes(w)&&(s-=1));return s;}
function renderNews(items){const box=$("newsList");box.innerHTML="";if(items.length===0){box.innerHTML=`<div class="muted">Nessuna notizia.</div>`;return;}
  items.forEach(it=>{const s=scoreSentiment(it.title),cls=s>0?"good":s<0?"bad":"muted",tag=s>0?"positivo":s<0?"negativo":"neutro";
    const div=document.createElement("div");div.className="news-item";
    div.innerHTML=`<b class="${cls}">${it.title}</b><div class="muted">${it.source||""} â€¢ ${it.lang||""}</div>
    <div style="margin-top:6px"><span class="tag ${cls}">${tag}</span> <a href="${it.url}" target="_blank" rel="noopener">Apri</a></div>`;box.appendChild(div);});}
function parseCSV(t){const L=t.trim().split(/\r?\n/),H=L[0].split(',').map(s=>s.trim().toLowerCase());const idx={t:H.findIndex(h=>["timestamp","date","time","t"].includes(h)),o:H.findIndex(h=>["open","o"].includes(h)),h:H.findIndex(h=>["high","h"].includes(h)),l:H.findIndex(h=>["low","l"].includes(h)),c:H.findIndex(h=>["close","c"].includes(h)),v:H.findIndex(h=>["volume","v"].includes(h))};const out=[];for(let i=1;i<L.length;i++){const c=L[i].split(',');if(c.length<5)continue;const raw=c[idx.t];const ts=/^\d{10,13}$/.test(raw)?Math.floor(+raw/1000):Math.floor(new Date(raw).getTime()/1000);out.push({time:ts,open:+c[idx.o],high:+c[idx.h],low:+c[idx.l],close:+c[idx.c],volume:idx.v>=0?+c[idx.v]:undefined});}return out.sort((a,b)=>a.time-b.time);}

/* ---------- UI ---------- */
function savePrefs(){localStorage.setItem("th_lang",$("lang").value);localStorage.setItem("th_symbol",$("symbol").value.trim());localStorage.setItem("th_interval",$("interval").value);}
function loadPrefs(){const l=localStorage.getItem("th_lang")||"it";$("lang").value=l;setLang(l);$("symbol").value=localStorage.getItem("th_symbol")||"DEMO";$("interval").value=localStorage.getItem("th_interval")||"1h";}
["symbol","interval"].forEach(id=>$(id).addEventListener("change",savePrefs));

async function loadSymbol(raw){
  const q=raw||$("symbol").value;
  STATUS("Carico "+q+"â€¦");
  try{
    const candles=await withTimeout(fetchUniversal(q),8000);
    updateAllCharts(candles);
    STATUS(clean(q)+" â€” candele: "+candles.length);
  }catch(e){
    STATUS("Errore/Timeout: "+(e.message||e)+" â€” passo a DEMO");
    updateAllCharts(genDemo(400,20000));
  }
}
$("search").addEventListener("click",()=>{const q=$("symbol").value.trim();if(!q){alert("Inserisci simbolo o nome (es. DEMO, BTCUSDT, EURUSD, XAUUSD, AAPL, ^SPX, ORO, DOLLARO)");return;}savePrefs();loadSymbol(q);});
$("refresh").addEventListener("click",()=>{const q=$("symbol").value.trim()||localStorage.getItem("th_symbol")||"DEMO";loadSymbol(q);});
$("symbol").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();$("search").click();}});
$("csv").addEventListener("change",async e=>{const f=e.target.files?.[0];if(!f)return;STATUS("Carico CSVâ€¦");try{const rows=parseCSV(await f.text());if(rows.length<20)throw new Error("CSV troppo corto");updateAllCharts(rows);STATUS(`CSV caricato: ${rows.length} candele`);}catch(err){STATUS("Errore CSV: "+err.message);}});
$("newsBtn").addEventListener("click",async()=>{try{$("newsList").innerHTML=`<div class="muted">Caricoâ€¦</div>`;renderNews(await fetchNews($("newsQ").value.trim()));}catch(_){$("newsList").innerHTML=`<div class="muted">Errore news.</div>`;}});

/* ----- avvio: grafico DEMO immediato ----- */
initCharts(); loadPrefs(); loadSymbol($("symbol").value||"DEMO");
});
</script>
</body>
</html>
