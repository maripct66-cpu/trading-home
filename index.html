<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Trading Home â€” Universale</title>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<style>
:root{
  --bg:#0b0f19; --panel:#121826; --text:#e5e7eb; --muted:#94a3b8;
  --bull:#22c55e; --bear:#ef4444; --accent:#38bdf8; --warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:10;background:#0b0f19cc;backdrop-filter:blur(8px);border-bottom:1px solid #1f2937}
.wrap{max-width:1120px;margin:0 auto;padding:12px}
h1{margin:6px 0 10px;font-size:26px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.input,.sel,.lang{padding:12px 14px;border-radius:12px;border:1px solid #1f2937;background:var(--panel);color:var(--text)}
.input{flex:1;min-width:180px}
.btn{padding:12px 16px;border:0;border-radius:12px;background:var(--accent);color:#001018;font-weight:600;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:12px}
.grid{display:grid;gap:12px}
@media (min-width:980px){ .grid-2{grid-template-columns:2fr 1fr} }
.muted{color:var(--muted);font-size:12px}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.pill{background:#0f172a;border:1px solid #1f2937;border-radius:999px;padding:8px 10px;font-size:12px}
.bad{color:var(--bear)} .good{color:var(--bull)} .warn{color:var(--warn)}
#chart,#rsiChart,#macdChart{width:100%}
#chart{height:440px} #rsiChart{height:160px} #macdChart{height:180px}
.news{display:grid;gap:8px}
.news-item{padding:10px;border-radius:12px;border:1px solid #1f2937;background:#0f172a}
.news-item b{display:block;margin-bottom:6px}
.tag{display:inline-block;padding:4px 8px;border:1px solid #1f2937;border-radius:999px;font-size:11px;margin-right:6px}
.toggle{display:flex;align-items:center;gap:6px}
@media (max-width:480px){ h1{font-size:22px} #chart{height:360px} }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1 id="t_title">Trading Home â€” Universale</h1>
      <select id="lang" class="lang">
        <option value="it">IT</option><option value="en">EN</option><option value="de">DE</option>
      </select>
    </div>
    <div class="row">
      <input id="symbol" class="input" placeholder="Esempi: BTCUSDT â€¢ EURUSD â€¢ XAUUSD â€¢ AAPL â€¢ ^SPX â€¢ DAX â€¢ DOLLARO â€¢ ORO"/>
      <select id="interval" class="sel" title="Intervallo (solo crypto Binance)">
        <option>1m</option><option>5m</option><option>15m</option>
        <option selected>1h</option><option>4h</option><option>1d</option>
      </select>
      <button id="search" class="btn">ðŸ”Ž <span data-i18n="search">Cerca</span></button>
      <button id="refresh" class="btn">â†» <span data-i18n="refresh">Aggiorna</span></button>
    </div>
    <div class="row" style="margin-top:6px">
      <label class="toggle">
        <input type="checkbox" id="togglePatterns" checked/>
        <span class="muted" data-i18n="showpat">Mostra pattern</span>
      </label>
      <div class="muted" id="t_note" style="margin-left:auto">
        Crypto (intraday) via Binance â€¢ Altri mercati (daily) via Stooq â€¢ CSV locale per tutto il resto
      </div>
    </div>
  </div>
</header>

<main class="wrap grid grid-2" style="padding-top:12px">
  <section class="card" style="grid-column:1/-1">
    <div class="row" style="justify-content:space-between;margin-bottom:6px">
      <div class="muted" id="status">Pronto</div>
    </div>
    <div id="chart"></div>
    <div id="rsiChart" style="margin-top:8px"></div>
    <div id="macdChart" style="margin-top:8px"></div>
    <div class="muted" style="margin-top:6px">Candele â€¢ EMA20/50/200 â€¢ RSI(14) â€¢ MACD(12,26,9)</div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px" data-i18n="prob">ProbabilitÃ  (didattica)</h3>
    <div class="kpi" style="margin-bottom:8px">
      <span class="pill"><span data-i18n="invest">Investire</span>: <b id="kpiBuy">â€”%</b></span>
      <span class="pill"><span data-i18n="disinvest">Disinvestire</span>: <b id="kpiSell">â€”%</b></span>
      <span class="pill"><span data-i18n="candles">Candele</span>: <b id="kpiCount">â€”</b></span>
    </div>
    <div id="signals" class="muted" style="margin:6px 0 10px"></div>
    <ul class="muted" style="line-height:1.6;margin:0;padding-left:18px">
      <li data-i18n="disclaimer">Stima educativa: trend + incroci EMA + pattern. Non Ã¨ consulenza finanziaria.</li>
    </ul>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px" data-i18n="news">Notizie finanziarie / geopolitiche</h3>
    <div class="row" style="margin-bottom:8px">
      <input id="newsQ" class="input" placeholder="es. bitcoin OR btc, rate cuts, oil"/>
      <button id="newsBtn" class="btn">ðŸ“° <span data-i18n="fetchnews">Carica notizie</span></button>
    </div>
    <div id="newsList" class="news"></div>
  </section>

  <section class="card" style="grid-column:1/-1">
    <h3 style="margin:0 0 8px" data-i18n="csvtitle">Carica CSV (azioni/bond/commodities)</h3>
    <input type="file" id="csv" accept=".csv"/>
    <div class="muted" style="margin-top:8px" id="csvhelp">
      Formato: <code>timestamp,open,high,low,close,volume</code> (ms o data ISO). Elaborazione locale.
    </div>
  </section>
</main>

<script>
/* ===== i18n ===== */
const I18N={
  it:{search:"Cerca",refresh:"Aggiorna",prob:"ProbabilitÃ  (didattica)",invest:"Investire",disinvest:"Disinvestire",
      candles:"Candele",disclaimer:"Stima educativa: trend + incroci EMA + pattern. Non Ã¨ consulenza finanziaria.",
      news:"Notizie finanziarie / geopolitiche",fetchnews:"Carica notizie",csvtitle:"Carica CSV (azioni/bond/commodities)",showpat:"Mostra pattern"},
  en:{search:"Search",refresh:"Refresh",prob:"Probabilities (educational)",invest:"Invest",disinvest:"Divest",
      candles:"Candles",disclaimer:"Educational estimate: trend + EMA crosses + patterns. Not investment advice.",
      news:"Financial / geopolitical news",fetchnews:"Fetch news",csvtitle:"Upload CSV (stocks/bonds/commodities)",showpat:"Show patterns"},
  de:{search:"Suchen",refresh:"Aktualisieren",prob:"Wahrscheinlichkeiten (Lernen)",invest:"Investieren",disinvest:"Desinvestieren",
      candles:"Kerzen",disclaimer:"Didaktische SchÃ¤tzung: Trend + EMA-Kreuzungen + Muster. Keine Anlageberatung.",
      news:"Finanz-/Geopolitik-News",fetchnews:"News laden",csvtitle:"CSV hochladen (Aktien/Anleihen/Rohstoffe)",showpat:"Muster anzeigen"}
};
const $=id=>document.getElementById(id);
function setLang(l){
  const d=I18N[l]||I18N.it;
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n"); if(d[k]) el.textContent=d[k];
  });
  $("t_title").textContent=l==="it"?"Trading Home â€” Universale":l==="en"?"Trading Home â€” Universal":"Trading Home â€” Universal";
}
$("lang").addEventListener("change",e=>{setLang(e.target.value);savePrefs();}); setLang("it");

/* ===== helpers / indicators ===== */
const avg=a=>a.reduce((x,y)=>x+y,0)/a.length;
function ema(vals, p){ const k=2/(p+1); const out=[]; let prev;
  for(let i=0;i<vals.length;i++){ const v=vals[i];
    if(i<p-1) out.push(null);
    else if(i===p-1){ const s=avg(vals.slice(0,p)); out.push(s); prev=s; }
    else{ const n=v*k+prev*(1-k); out.push(n); prev=n; }
  } return out;
}
function rsi(closes, period=14){
  const out=[]; let gains=0, losses=0;
  for(let i=1;i<closes.length;i++){
    const ch=closes[i]-closes[i-1];
    if(i<=period){ if(ch>0) gains+=ch; else losses-=ch; out.push(null); continue; }
    const avgG=(gains+(ch>0?ch:0))/period, avgL=(losses+(ch<0?-ch:0))/period;
    gains=avgG*period; losses=avgL*period;
    const rs=avgL===0?100:avgG/avgL; const v=100-(100/(1+rs)); out.push(v);
  } return out;
}
function macd(closes, fast=12, slow=26, signal=9){
  const emaF=ema(closes,fast), emaS=ema(closes,slow);
  const macdLine=closes.map((_,i)=> (emaF[i]!=null&&emaS[i]!=null)?emaF[i]-emaS[i]:null);
  const sig=ema(macdLine.map(v=>v??0), signal).map((v,i)=> macdLine[i]==null?null:v);
  const hist=macdLine.map((v,i)=> (v==null||sig[i]==null)?null:(v-sig[i]));
  return {macdLine, signal:sig, hist};
}
function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
function fmt(ts){ return new Date(ts*1000).toLocaleString('it-IT',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'}); }

/* ===== charts ===== */
let chart, rsiChart, macdChart, lastCandles=[];
function baseChartOpts(){ return {
  chart:{type:'candlestick',height:440,background:'#121826',foreColor:'#e5e7eb',
    toolbar:{show:true,tools:{pan:true,zoom:true,zoomin:true,zoomout:true,reset:true}},zoom:{enabled:true}},
  theme:{mode:'dark'}, series:[], xaxis:{type:'datetime'}, yaxis:{tooltip:{enabled:true},decimalsInFloat:2},
  grid:{borderColor:'#1f2937'}, plotOptions:{candlestick:{colors:{upward:getCSS('--bull'),downward:getCSS('--bear')},wick:{useFillColor:true}}}
};}
function initCharts(){
  chart=new ApexCharts($("#chart"), baseChartOpts()); chart.render();
  rsiChart=new ApexCharts($("#rsiChart"),{
    chart:{type:'line',height:160,background:'#121826',foreColor:'#e5e7eb',toolbar:{show:false}},
    theme:{mode:'dark'}, series:[], xaxis:{type:'datetime'}, yaxis:{min:0,max:100,tickAmount:5},
    annotations:{yaxis:[{y:70, borderColor:'#ef4444'},{y:30,borderColor:'#22c55e'}]},
    grid:{borderColor:'#1f2937'}
  }); rsiChart.render();
  macdChart=new ApexCharts($("#macdChart"),{
    chart:{type:'line',height:180,background:'#121826',foreColor:'#e5e7eb',toolbar:{show:false}},
    theme:{mode:'dark'}, series:[], xaxis:{type:'datetime'}, yaxis:{decimalsInFloat:4}, grid:{borderColor:'#1f2937'}
  }); macdChart.render();
}
function toSeries(c){ return c.map(k=>({x:new Date(k.time*1000),y:[k.open,k.high,k.low,k.close]})); }
function updateAllCharts(candles){
  lastCandles=candles.slice();
  const closes=candles.map(x=>x.close);
  const e20=ema(closes,20), e50=ema(closes,50), e200=ema(closes,200);
  chart.updateSeries([
    {name:'Candele',type:'candlestick',data:toSeries(candles)},
    {name:'EMA20',type:'line',data:candles.map((c,i)=>({x:new Date(c.time*1000),y:e20[i]})),color:getCSS('--accent')},
    {name:'EMA50',type:'line',data:candles.map((c,i)=>({x:new Date(c.time*1000),y:e50[i]})),color:'#9aa7ff'},
    {name:'EMA200',type:'line',data:candles.map((c,i)=>({x:new Date(c.time*1000),y:e200[i]})),color:'#f59e0b'}
  ],true);
  const r=rsi(closes,14);
  rsiChart.updateSeries([{name:'RSI(14)',data:candles.map((c,i)=>({x:new Date(c.time*1000),y:r[i]}))}],true);
  const {macdLine,signal,hist}=macd(closes,12,26,9);
  macdChart.updateSeries([
    {name:'MACD',data:candles.map((c,i)=>({x:new Date(c.time*1000),y:macdLine[i]}))},
    {name:'Signal',data:candles.map((c,i)=>({x:new Date(c.time*1000),y:signal[i]}))},
    {name:'Histogram',type:'bar',data:candles.map((c,i)=>({x:new Date(c.time*1000),y:hist[i]}))}
  ],true);
  updateKPIs(candles,e20,e50);
  if($("#togglePatterns").checked) detectPatterns(candles); else $("signals").innerHTML="";
}

/* ===== KPIs ===== */
function updateKPIs(candles,e20,e50){
  $("kpiCount").textContent=candles.length;
  if(candles.length<5){$("kpiBuy").textContent="â€”%";$("kpiSell").textContent="â€”%";return;}
  const first=candles[0].close,last=candles.at(-1).close; const perf=((last-first)/first)*100;
  const idx=e50.findLastIndex(v=>v!=null); let bonus=0;
  if(idx>0&&e20[idx]!=null&&e50[idx]!=null){
    const up=e20[idx]>e50[idx]&&e20[idx-1]<=e50[idx-1];
    const dn=e20[idx]<e50[idx]&&e20[idx-1]>=e50[idx-1];
    if(up) bonus+=8; if(dn) bonus-=8;
  }
  const buy=Math.max(5,Math.min(95,50+perf*0.6+bonus));
  $("kpiBuy").textContent=buy.toFixed(0)+"%"; $("kpiSell").textContent=(100-buy).toFixed(0)+"%";
}

/* ===== Pattern detection (ridotto & pulito) ===== */
function localExtremaWithStrength(arr,look=3){
  const tops=[],bots=[];
  for(let i=look;i<arr.length-look;i++){
    const L=arr.slice(i-look,i), R=arr.slice(i+1,i+1+look), v=arr[i];
    const isTop=L.every(x=>x<v)&&R.every(x=>x<v), isBot=L.every(x=>x>v)&&R.every(x=>x>v);
    if(isTop){ const n=Math.max(Math.max(...L),Math.max(...R)); tops.push({i,strength:(v-n)/Math.max(1e-9,n)}); }
    if(isBot){ const n=Math.min(Math.min(...L),Math.min(...R)); bots.push({i,strength:(n-v)/Math.max(1e-9,v)}); }
  } return {tops,bots};
}
function detectPatterns(c){
  const closes=c.map(k=>k.close); const {tops,bots}=localExtremaWithStrength(closes,3);
  const mean=avg(closes.slice(-Math.min(200,closes.length))); const tol=0.0075, minSep=8, maxS=6; const signals=[];
  for(let a=0;a<tops.length-1;a++) for(let b=a+1;b<tops.length;b++){
    const i=tops[a].i,j=tops[b].i; if(j-i<minSep) continue;
    const near=Math.abs(closes[i]-closes[j])/((closes[i]+closes[j])/2)<=tol; if(!near) continue;
    const midMin=Math.min(...closes.slice(i+1,j)); const necklineOk=(Math.max(closes[i],closes[j])-midMin)/mean>0.004;
    if(!necklineOk) continue; const score=(tops[a].strength+tops[b].strength)+(j-i)*0.001; signals.push({type:'Double Top',idx:j,score,ts:c[j].time}); break;
  }
  for(let a=0;a<bots.length-1;a++) for(let b=a+1;b<bots.length;b++){
    const i=bots[a].i,j=bots[b].i; if(j-i<minSep) continue;
    const near=Math.abs(closes[i]-closes[j])/((closes[i]+closes[j])/2)<=tol; if(!near) continue;
    const midMax=Math.max(...closes.slice(i+1,j)); const necklineOk=(midMax-Math.min(closes[i],closes[j]))/mean>0.004;
    if(!necklineOk) continue; const score=Math.abs(bots[a].strength+bots[b].strength)+(j-i)*0.001; signals.push({type:'Double Bottom',idx:j,score,ts:c[j].time}); break;
  }
  for(let k=1;k<tops.length-1;k++){
    const L=tops[k-1].i,H=tops[k].i,R=tops[k+1].i; if(R-L<minSep) continue;
    const headHigher=closes[H]>closes[L]*1.01&&closes[H]>closes[R]*1.01;
    const shouldersNear=Math.abs(closes[L]-closes[R])/((closes[L]+closes[R])/2)<=0.015;
    if(headHigher&&shouldersNear){ const score=(tops[k].strength-Math.abs(tops[k-1].strength-tops[k+1].strength)*0.2); signals.push({type:'Testa-Spalle',idx:H,score,ts:c[H].time}); }
  }
  signals.sort((a,b)=>b.score-a.score);
  const picked=[]; for(const s of signals){ if(picked.length>=maxS) break; if(picked.some(p=>Math.abs(p.idx-s.idx)<12&&p.type===s.type)) continue; picked.push(s); }
  $("signals").innerHTML = picked.length===0 ? "Pattern: nessun segnale evidente." :
    "Pattern: "+picked.map(s=>`<span class="tag ${s.type.includes('Top')?'bad':s.type.includes('Bottom')?'good':'warn'}">${s.type} â€” ${fmt(s.ts)}</span>`).join(" ");
}

/* ===== universal sources (Binance + Stooq) ===== */
// normalizza input: maiuscole, togli accenti/spazi/slash, riduci ripetizioni (DOLLLARO -> DOLLARO)
function clean(s){
  return (s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toUpperCase()
    .replace(/\s+/g,"")
    .replace(/\//g,"")
    .replace(/(.)\1{2,}/g,"$1$1");
}
// sinonimi italiani comuni
const IT_SYNONYMS = {
  "DOLLARO":"EURUSD","EURO":"EURUSD","STERLINA":"GBPUSD","YEN":"USDJPY","FRANCO":"USDCHF",
  "ORO":"XAUUSD","ARGENTO":"XAGUSD","PETROLIO":"BRENT","WTI":"WTI",
  "NASDAQ":"^NDQ","SP500":"^SPX","S&P500":"^SPX","SNP500":"^SPX","INDICESP500":"^SPX",
  "DAX":"^DAX","FTSEMIB":"^FTMIB","MIB":"^FTMIB","FTSE100":"^FTSE"
};
// alias estesi
const ALIAS = {
  // crypto
  "BITCOIN":"BTCUSDT","BTC":"BTCUSDT","ETHEREUM":"ETHUSDT","ETH":"ETHUSDT",
  "BNB":"BNBUSDT","SOL":"SOLUSDT","XRP":"XRPUSDT","ADA":"ADAUSDT","DOGE":"DOGEUSDT","MATIC":"MATICUSDT",
  // forex (EN/IT)
  "EURUSD":"EURUSD","GBPUSD":"GBPUSD","USDJPY":"USDJPY","GBPJPY":"GBPJPY","USDCHF":"USDCHF",
  "EUR/USD":"EURUSD","GBP/USD":"GBPUSD","USD/JPY":"USDJPY","GBP/JPY":"GBPJPY","USD/CHF":"USDCHF",
  // metalli / commodities
  "XAUUSD":"XAUUSD","XAGUSD":"XAGUSD","BRENT":"BRENT","WTI":"WTI",
  // indici
  "SP500":"^SPX","S&P500":"^SPX","SPX":"^SPX","^SPX":"^SPX","NASDAQ":"^NDQ","^NDQ":"^NDQ",
  "DAX":"^DAX","^DAX":"^DAX","FTSEMIB":"^FTMIB","^FTMIB":"^FTMIB","FTSE100":"^FTSE","^FTSE":"^FTSE",
  // bond yield (se disponibili su Stooq)
  "US10Y":"US10Y","DE10Y":"DE10Y"
};
function detectSource(raw){
  let q = clean(raw);
  if (IT_SYNONYMS[q]) q = IT_SYNONYMS[q];
  if (ALIAS[q]) q = ALIAS[q];

  // Crypto Binance se termina in USDT
  if (/^[A-Z0-9]+USDT$/.test(q)) return { src:"binance", symbol:q };

  // Tutto il resto: Stooq (daily)
  let sym = q.toLowerCase();

  // FX 6 lettere (eurusd)
  if (/^[a-z]{6}$/.test(sym)) return { src:"stooq", symbol:sym };

  // Indici ^spx, ^ndq...
  if (/^\^/.test(q)) return { src:"stooq", symbol:q.toLowerCase() };

  // Commodities note
  if (/(brent|wti|xauusd|xagusd)/i.test(sym)) return { src:"stooq", symbol:sym };

  // Azioni senza suffisso -> USA di default
  if (/^[a-z]{1,6}$/.test(sym)) sym += ".us";

  return { src:"stooq", symbol:sym };
}
// Binance (intraday)
async function fetchBinanceCandles(symbol, interval='1h', limit=800){
  const url=`https://api.binance.com/api/v3/klines?symbol=${encodeURIComponent(symbol)}&interval=${interval}&limit=${limit}`;
  const r=await fetch(url); if(!r.ok) throw new Error("Binance error");
  const data=await r.json();
  return data.map(d=>({time:Math.floor(d[0]/1000),open:+d[1],high:+d[2],low:+d[3],close:+d[4],volume:+d[5]}));
}
// Stooq (daily)
async function fetchStooqDaily(symbol, limit=800){
  const url=`https://stooq.com/q/d/l/?s=${encodeURIComponent(symbol)}&i=d`;
  const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error("Stooq error");
  const text=await r.text(); const lines=text.trim().split(/\r?\n/); const out=[];
  for(let i=1;i<lines.length;i++){
    const [DateStr,Open,High,Low,Close,Volume]=lines[i].split(",");
    if(!DateStr||!Open) continue;
    const ts=Math.floor(new Date(DateStr+"T00:00:00Z").getTime()/1000);
    out.push({time:ts,open:+Open,high:+High,low:+Low,close:+Close,volume:+(Volume||0)});
  }
  return out.sort((a,b)=>a.time-b.time).slice(-limit);
}
// Loader unico
async function fetchUniversal(raw){
  const {src,symbol}=detectSource(raw);
  if(src==="binance"){ const itv=$("interval").value; return await fetchBinanceCandles(symbol,itv,800); }
  else{ const data=await fetchStooqDaily(symbol,800); if(!data.length) throw new Error("Nessun dato da Stooq per "+symbol); return data; }
}

/* ===== data: CSV & news ===== */
function parseCSV(text){
  const L=text.trim().split(/\r?\n/), H=L[0].split(',').map(s=>s.trim().toLowerCase());
  const idx={t:H.findIndex(h=>["timestamp","date","time","t"].includes(h)),o:H.findIndex(h=>["open","o"].includes(h)),
             h:H.findIndex(h=>["high","h"].includes(h)),l:H.findIndex(h=>["low","l"].includes(h)),
             c:H.findIndex(h=>["close","c"].includes(h)),v:H.findIndex(h=>["volume","v"].includes(h))};
  const out=[]; for(let i=1;i<L.length;i++){ const cols=L[i].split(','); if(cols.length<5) continue;
    const raw=cols[idx.t]; const ts=/^\d{10,13}$/.test(raw)?Math.floor(+raw/1000):Math.floor(new Date(raw).getTime()/1000);
    out.push({time:ts,open:+cols[idx.o],high:+cols[idx.h],low:+cols[idx.l],close:+cols[idx.c],volume:idx.v>=0?+cols[idx.v]:undefined});
  } return out.sort((a,b)=>a.time-b.time);
}
async function fetchNews(q,max=10){
  const query=encodeURIComponent(q||$("symbol").value||"markets");
  const url=`https://api.gdeltproject.org/api/v2/doc/doc?query=${query}&mode=ArtList&maxrecords=${max}&format=json`;
  const r=await fetch(url); if(!r.ok) throw new Error("GDELT error"); const js=await r.json();
  return (js?.articles||[]).map(a=>({title:a.title,url:a.url,source:a.sourceCountry||a.domain,lang:a.language,datetime:a.seendate}));
}
function scoreSentiment(t){ t=t.toLowerCase(); const pos=["beat","surge","rally","upgrade","record","growth","bull","accelera","sale","utile","forte"];
  const neg=["drop","selloff","downgrade","miss","crash","war","probe","fine","indagine","taglio","debole"]; let s=0;
  pos.forEach(w=>t.includes(w)&&(s+=1)); neg.forEach(w=>t.includes(w)&&(s-=1)); return s; }
function renderNews(items){
  const box=$("newsList"); box.innerHTML=""; if(items.length===0){box.innerHTML=`<div class="muted">Nessuna notizia.</div>`;return;}
  items.forEach(it=>{const s=scoreSentiment(it.title),cls=s>0?"good":s<0?"bad":"muted",tag=s>0?"positivo":s<0?"negativo":"neutro";
    const div=document.createElement("div"); div.className="news-item";
    div.innerHTML=`<b class="${cls}">${it.title}</b><div class="muted">${it.source||""} â€¢ ${it.lang||""}</div>
    <div style="margin-top:6px"><span class="tag ${cls}">${tag}</span> <a href="${it.url}" target="_blank" rel="noopener">Apri</a></div>`;
    box.appendChild(div); });
}

/* ===== UI ===== */
async function loadSymbol(raw){
  const q = raw || $("symbol").value;
  $("status").textContent = "Carico " + q + "â€¦";
  try{
    const candles = await fetchUniversal(q);
    updateAllCharts(candles);
    $("status").textContent = `${clean(q)} â€” candele: ${candles.length}`;
  }catch(e){
    $("status").textContent = "Errore: " + e.message;
    alert("Simbolo non valido o rete non disponibile.\nEsempi:\n- Crypto: BTCUSDT\n- Forex: EURUSD\n- Oro: XAUUSD\n- Azioni USA: AAPL (o aapl.us)\n- Indici: ^SPX, ^NDQ\n- Parole: DOLLARO, ORO, NASDAQâ€¦");
  }
}
$("search").addEventListener("click", () => {
  const q = $("symbol").value.trim();
  if (!q) { alert("Inserisci un simbolo o nome (es. BTCUSDT, EURUSD, XAUUSD, AAPL, ^SPX, ORO, DOLLARO)"); return; }
  savePrefs(); loadSymbol(q);
});
$("refresh").addEventListener("click", () => {
  const q = $("symbol").value.trim() || localStorage.getItem("th_symbol") || "BTCUSDT";
  loadSymbol(q);
});
$("symbol").addEventListener("keydown", (e) => { if(e.key==="Enter"){ e.preventDefault(); $("search").click(); }});

$("csv").addEventListener("change",async e=>{
  const f=e.target.files?.[0]; if(!f) return; $("status").textContent="Carico CSVâ€¦";
  try{ const rows=parseCSV(await f.text()); if(rows.length<20) throw new Error("CSV troppo corto");
    updateAllCharts(rows); $("status").textContent=`CSV caricato: ${rows.length} candele`;
  }catch(err){ $("status").textContent="Errore CSV: "+err.message; alert(err.message); }
});
$("newsBtn").addEventListener("click",async()=>{ try{$("newsList").innerHTML=`<div class="muted">Caricoâ€¦</div>`; renderNews(await fetchNews($("newsQ").value.trim()));}
  catch(e){$("newsList").innerHTML=`<div class="muted">Errore news.</div>`;}});

$("togglePatterns").addEventListener("change",()=>{ if($("#togglePatterns").checked && lastCandles.length) detectPatterns(lastCandles); else $("signals").innerHTML=""; });

/* ===== prefs & boot ===== */
function savePrefs(){ localStorage.setItem("th_lang",$("lang").value); localStorage.setItem("th_symbol",$("symbol").value.trim()); localStorage.setItem("th_interval",$("interval").value); }
function loadPrefs(){ const l=localStorage.getItem("th_lang")||"it"; $("lang").value=l; setLang(l);
  $("symbol").value=localStorage.getItem("th_symbol")||"BTCUSDT"; $("interval").value=localStorage.getItem("th_interval")||"1h"; }
["symbol","interval"].forEach(id=>$(id).addEventListener("change",savePrefs));

initCharts(); loadPrefs(); loadSymbol($("symbol").value||"BTCUSDT");
</script>
</body>
</html>
